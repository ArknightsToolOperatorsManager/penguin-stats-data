name: Extract Stage Types Analysis

on:
  # ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œ
  workflow_run:
    workflows: ["Fetch Penguin Statistics Daily"]
    types:
      - completed
    branches: [main]
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_analysis:
        description: 'Force analysis even if no new data'
        required: false
        default: 'false'
        type: boolean

# åŒã˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒé‡è¤‡å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«åˆ¶å¾¡
concurrency:
  group: stage-types-analysis
  cancel-in-progress: true

jobs:
  extract-stage-types:
    # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€æ–°çµæœã‚’å–å¾—
        ref: ${{ github.event.workflow_run.head_branch || github.ref }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd scripts
        npm install node-fetch
    
    - name: Check if latest data exists
      id: check_data
      run: |
        if [ -f "data/latest.json" ]; then
          echo "data_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Latest data file found"
        else
          echo "data_exists=false" >> $GITHUB_OUTPUT
          echo "âŒ Latest data file not found"
        fi
    
    - name: Extract stage types
      if: steps.check_data.outputs.data_exists == 'true'
      env:
        GAS_WEBHOOK_URL: ${{ secrets.GAS_WEBHOOK_URL }}
      run: |
        cd scripts
        echo "ğŸ” Starting stage types analysis..."
        node extract-stage-types.js
    
    - name: Check for new stage types
      id: check_new_types
      if: steps.check_data.outputs.data_exists == 'true'
      run: |
        if [ -f "data/latest-new-stage-types.json" ]; then
          NEW_COUNT=$(jq length data/latest-new-stage-types.json)
          echo "new_types_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "has_new_types=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $NEW_COUNT new stage types"
        else
          echo "new_types_count=0" >> $GITHUB_OUTPUT
          echo "has_new_types=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š No new stage types found"
        fi
    
    - name: Commit new analysis results
      if: steps.check_new_types.outputs.has_new_types == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "=== Adding analysis files ==="
        git add data/
        
        echo "=== Git status ==="
        git status
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          echo "âœ… Committing stage types analysis results..."
          git commit -m "Add stage types analysis - found ${{ steps.check_new_types.outputs.new_types_count }} new types - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: Summary
      run: |
        echo "ğŸ Stage types analysis completed!"
        echo "ğŸ“Š Data processed: ${{ steps.check_data.outputs.data_exists }}"
        echo "ğŸ†• New types found: ${{ steps.check_new_types.outputs.has_new_types }}"
        echo "ğŸ“ˆ New types count: ${{ steps.check_new_types.outputs.new_types_count }}"
        if [ "${{ steps.check_new_types.outputs.has_new_types }}" == "true" ]; then
          echo "ğŸ”¶ New stage types sent to Google Spreadsheet with orange highlighting"
          echo "ğŸ“ Manual work needed: Add Japanese, English, and Chinese names to the spreadsheet"
        fi
