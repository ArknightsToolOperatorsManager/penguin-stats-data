name: Extract Stage Types Analysis

on:
  # ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œ
  workflow_run:
    workflows: ["Fetch Penguin Statistics Daily"]
    types:
      - completed
    branches: [main]
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_analysis:
        description: 'Force analysis even if no new data'
        required: false
        default: 'false'
        type: boolean

# åŒã˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒé‡è¤‡å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«åˆ¶å¾¡
concurrency:
  group: stage-types-analysis
  cancel-in-progress: true

jobs:
  extract-stage-types:
    # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€æ–°çµæœã‚’å–å¾—
        ref: ${{ github.event.workflow_run.head_branch || github.ref }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd scripts
        npm install node-fetch
    
    - name: Check if latest data exists
      id: check_data
      run: |
        if [ -f "data/latest.json" ]; then
          echo "data_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Latest data file found"
        else
          echo "data_exists=false" >> $GITHUB_OUTPUT
          echo "âŒ Latest data file not found"
        fi
    
    - name: Extract stage types
      if: steps.check_data.outputs.data_exists == 'true'
      env:
        GAS_WEBHOOK_URL: ${{ secrets.GAS_WEBHOOK_URL }}
      run: |
        cd scripts
        echo "ğŸ” Starting stage types analysis..."
        node extract-stage-types.js
    
    - name: Check for new stage types
      id: check_new_types
      if: steps.check_data.outputs.data_exists == 'true'
      run: |
        if [ -f "data/latest-new-stage-types.json" ]; then
          NEW_COUNT=$(jq length data/latest-new-stage-types.json)
          echo "new_types_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "has_new_types=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $NEW_COUNT new stage types"
        else
          echo "new_types_count=0" >> $GITHUB_OUTPUT
          echo "has_new_types=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š No new stage types found"
        fi
    
    - name: Commit new analysis results
      if: steps.check_new_types.outputs.has_new_types == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "=== Adding analysis files ==="
        git add data/
        
        echo "=== Git status ==="
        git status
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          echo "âœ… Committing stage types analysis results..."
          git commit -m "Add stage types analysis - found ${{ steps.check_new_types.outputs.new_types_count }} new types - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: Create issue for new stage types
      if: steps.check_new_types.outputs.has_new_types == 'true' && steps.check_new_types.outputs.new_types_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const newTypes = JSON.parse(fs.readFileSync('data/latest-new-stage-types.json', 'utf8'));
            
            let issueBody = `## ğŸ†• æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ\n\n`;
            issueBody += `**ç™ºè¦‹æ•°**: ${newTypes.length}å€‹\n\n`;
            issueBody += `### ğŸ” æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ä¸€è¦§\n\n`;
            
            newTypes.forEach((type, index) => {
              issueBody += `#### ${index + 1}. \`${type.stageType}\`\n`;
              issueBody += `- **å‡ºç¾ã‚¹ãƒ†ãƒ¼ã‚¸æ•°**: ${type.count}\n`;
              issueBody += `- **ä¿¡é ¼åº¦**: ${type.avgConfidence}\n`;
              issueBody += `- **ä¾‹**: ${type.examples}\n\n`;
            });
            
            issueBody += `### ğŸ“ ä½œæ¥­ãŒå¿…è¦\n\n`;
            issueBody += `ä»¥ä¸‹ã®Google Spreadsheetã«æ—¥æœ¬èªåã‚’è¿½åŠ ã—ã¦ãã ã•ã„:\n`;
            issueBody += `https://docs.google.com/spreadsheets/d/1ZJ85ZwS1fJFwZ9KZp0YCNzsRRMXx1vMiEaOfr-lYTw8/edit#gid=0\n\n`;
            issueBody += `### ğŸ“„ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«\n`;
            issueBody += `- \`data/latest-new-stage-types.json\` - è©³ç´°ãƒ‡ãƒ¼ã‚¿\n`;
            issueBody += `- \`data/latest-new-stage-types.csv\` - CSVå½¢å¼ï¼ˆç¢ºèªç”¨ï¼‰\n\n`;
            issueBody += `---\n*ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ†• æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ç™ºè¦‹ (${newTypes.length}å€‹) - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['stage-types', 'auto-generated', 'needs-manual-work']
            });
            
            console.log(`ğŸ“‹ Issue created: ${issue.data.html_url}`);
          } catch (error) {
            console.error('âŒ Error creating issue:', error);
          }
    
    - name: Summary
      run: |
        echo "ğŸ Stage types analysis completed!"
        echo "ğŸ“Š Data processed: ${{ steps.check_data.outputs.data_exists }}"
        echo "ğŸ†• New types found: ${{ steps.check_new_types.outputs.has_new_types }}"
        echo "ğŸ“ˆ New types count: ${{ steps.check_new_types.outputs.new_types_count }}"